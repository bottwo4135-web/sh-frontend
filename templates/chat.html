{% extends 'base.html' %}
{% block content %}
<section class="chat-page">
  <aside class="sidebar">
    <div class="profile">
      <img class="avatar" src="{{ url_for('static', filename=user['avatar']) if user['avatar'] else 'https://i.pravatar.cc/100?img=2' }}" alt="avatar">
      <div>
        <div class="name">{{ user['name'] }}</div>
        <div class="muted">{{ user['role']|capitalize }}</div>
      </div>
    </div>
    {% if user['role'] == 'patient' %}
      <a class="btn ghost" href="{{ url_for('patient_dashboard') }}">← Back to Doctors</a>
    {% else %}
      <a class="btn ghost" href="{{ url_for('doctor_dashboard') }}">← Back to Chats</a>
    {% endif %}
  </aside>

  <section class="chat-content">
    <div class="chat-header">
      <img class="avatar" src="{{ url_for('static', filename=other['avatar']) if other['avatar'] else 'https://i.pravatar.cc/100?img=11' }}" />
      <div class="meta">
        <div class="name">{{ 'Dr. ' if other['role']=='doctor' else '' }}{{ other['name'] }}</div>
        <div class="muted">{{ other['specialty'] if other['role']=='doctor' else 'Patient' }}</div>
      </div>
    </div>

    <div id="log" class="chat-log">
      {% for m in messages %}
      <div class="msg {{ 'me' if m['sender_id']==user['id'] else 'other' }}">
        <img class="avatar" src="{{ url_for('static', filename=m['avatar']) if m['avatar'] else 'https://i.pravatar.cc/60' }}"/>
        <div class="bubble">
          <div class="name">{{ m['name'] }}</div>
          <div class="text">{{ m['message'] }}</div>
          <div class="time">{{ m['created_at'] }}</div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="composer">
      <input id="composer" placeholder="Type a message..." />
      <button id="send" class="btn primary">Send</button>
      <button id="ask-ai" class="btn secondary">Ask AI</button>
    </div>
  </section>
</section>
{% endblock %}

{% block scripts %}
<script>
  // Injected variables
  const chatId = {{ chat_id|int }};
  const userId = {{ user['id']|int }};
  const userAvatar = "{{ user['avatar'] or '' }}";
  const log = document.getElementById('log');
  const composer = document.getElementById('composer');
  const sendBtn = document.getElementById('send');
  const askAiBtn = document.getElementById('ask-ai');
  // Track rendered messages to avoid duplicates
  const seen = new Set();
  let lastTs = null; // last server message timestamp
  const BASE_URL = 'https://shs-backend-ktg8.onrender.com';

  function makeKey(msg){
    if (msg.id) return `id:${msg.id}`;
    return `tmp:${msg.sender_id}:${msg.created_at}:${msg.message}`;
  }

  function render(msg){
    const key = makeKey(msg);
    if (seen.has(key)) return;
    seen.add(key);
    const wrap = document.createElement('div');
    wrap.className = 'msg ' + (msg.sender_id == userId ? 'me':'other');
    const avatar = document.createElement('img');
    avatar.className = 'avatar';
    avatar.src = msg.avatar ? ('/static/' + msg.avatar) : 'https://i.pravatar.cc/60';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = msg.name;
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = msg.message;
    const time = document.createElement('div');
    time.className = 'time';
    time.textContent = new Date(msg.created_at).toLocaleString();
    bubble.appendChild(name); bubble.appendChild(text); bubble.appendChild(time);
    wrap.appendChild(avatar); wrap.appendChild(bubble);
    log.appendChild(wrap); log.scrollTop = log.scrollHeight;
    if (msg.id) lastTs = msg.created_at; // advance only on server-confirmed messages
  }

  async function poll(){
    try{
      const url = lastTs ? `${BASE_URL}/api/messages/${chatId}?after=${encodeURIComponent(lastTs)}` : `${BASE_URL}/api/messages/${chatId}`;
      const res = await fetch(url);
      const data = await res.json();
      data.forEach(render);
    }catch(e){ /* ignore transient errors */ }
    setTimeout(poll, 1500);
  }
  poll();

  async function send(){
    const msg = composer.value.trim();
    if(!msg) return;
    const optimistic = { sender_id: userId, name: 'You', avatar: userAvatar, message: msg, created_at: new Date().toISOString() };
    render(optimistic); // render optimistically with tmp key
    composer.value='';
    const form = new FormData(); form.append('chat_id', chatId); form.append('message', msg);
    await fetch(`${BASE_URL}/api/send`, { method:'POST', body: form });
  }
  sendBtn.addEventListener('click', send);
  composer.addEventListener('keypress', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); send(); }});

  async function askAI(){
    const msg = composer.value.trim();
    if(!msg) return;
    // Show user message
    const optimistic = { sender_id: userId, name: 'You', avatar: userAvatar, message: msg, created_at: new Date().toISOString() };
    render(optimistic);
    composer.value='';
    // Fetch AI reply
    try {
      const res = await fetch(`${BASE_URL}/api/ai`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      if(data.reply){
        const aiMsg = {
          sender_id: 0, // 0 for AI
          name: 'AI Assistant',
          avatar: 'https://i.pravatar.cc/60?img=5',
          message: data.reply,
          created_at: new Date().toISOString()
        };
        render(aiMsg);
      }
    } catch(e) {
      const errMsg = {
        sender_id: 0,
        name: 'AI Assistant',
        avatar: 'https://i.pravatar.cc/60?img=5',
        message: 'AI service is unavailable.',
        created_at: new Date().toISOString()
      };
      render(errMsg);
    }
  }
  askAiBtn.addEventListener('click', askAI);
</script>
{% endblock %}
<link rel="icon" href="https://i.pravatar.cc/32?img=2" type="image/x-icon">
