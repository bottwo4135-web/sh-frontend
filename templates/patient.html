{% extends 'base.html' %}
{% block content %}
<section class="dashboard">
  <aside class="sidebar">
    <div class="profile">
      <img class="avatar" src="{{ url_for('static', filename=user['avatar']) if user['avatar'] else 'https://i.pravatar.cc/100?img=1' }}" alt="avatar">
      <div>
        <div class="name">{{ user['name'] }}</div>
        <div class="muted">Patient</div>
      </div>
    </div>
    <a class="btn ghost" href="{{ url_for('logout') }}">Logout</a>
  </aside>

  <section class="content">
    <h2>Find a Doctor</h2>
    <div class="filters">
      <input id="search" placeholder="Search by name or specialty" />
    </div>
    <div class="doctor-list" id="doctorList">
      {% for d in doctors %}
      <a class="doctor-card slide-up" href="{{ url_for('chat_room', other_id=d['id']) }}" data-name="{{ d['name']|lower }}" data-specialty="{{ (d['specialty'] or '')|lower }}">
        <img class="avatar xl" src="{{ url_for('static', filename=d['avatar']) if d['avatar'] else 'https://i.pravatar.cc/100?img=14' }}" />
        <div class="info">
          <div class="name">Dr. {{ d['name'] }}</div>
          <div class="muted">{{ d['specialty'] or 'General' }}</div>
        </div>
        <div class="status {{ 'online' if d['availability'] else 'offline' }}">
          {{ 'Available' if d['availability'] else 'Unavailable' }}
          {% if d['free_at'] %}<span class="muted"> â€¢ free at {{ d['free_at'] }}</span>{% endif %}
        </div>
      </a>
      {% endfor %}
    </div>

    <button id="aiFab" class="fab pulse" title="Ask AI">ðŸ¤–</button>

    <div id="aiModal" class="modal hidden">
      <div class="modal-content">
        <div class="modal-header">
          <h3>AI Health Assistant</h3>
          <button id="aiClose" class="icon-btn">âœ–</button>
        </div>
        <div id="aiLog" class="ai-log"></div>
        <div class="ai-input">
          <input id="aiPrompt" placeholder="Describe your symptom or question..." />
          <button id="aiSend" class="btn primary">Send</button>
        </div>
      </div>
    </div>
  </section>
</section>
{% endblock %}

{% block scripts %}
<script>
  // Filter list
  const search = document.getElementById('search');
  search.addEventListener('input', () => {
    const q = search.value.toLowerCase();
    document.querySelectorAll('#doctorList .doctor-card').forEach(el => {
      const match = el.dataset.name.includes(q) || el.dataset.specialty.includes(q);
      el.style.display = match ? '' : 'none';
    });
  });

  // AI modal behavior
  const aiFab = document.getElementById('aiFab');
  const aiModal = document.getElementById('aiModal');
  const aiClose = document.getElementById('aiClose');
  const aiLog = document.getElementById('aiLog');
  const aiPrompt = document.getElementById('aiPrompt');
  const aiSend = document.getElementById('aiSend');
  const BASE_URL = 'https://shs-backend-ktg8.onrender.com';

  function appendAI(role, text){
    const wrap = document.createElement('div');
    wrap.className = 'ai-msg ' + role;
    wrap.textContent = text;
    aiLog.appendChild(wrap);
    aiLog.scrollTop = aiLog.scrollHeight;
  }

  aiFab.addEventListener('click', ()=> aiModal.classList.remove('hidden'));
  aiClose.addEventListener('click', ()=> aiModal.classList.add('hidden'));
  aiSend.addEventListener('click', async () => {
    const msg = aiPrompt.value.trim();
    if(!msg) return;
    appendAI('user', msg);
    aiPrompt.value = '';
    const form = new FormData();
    form.append('message', msg);
    appendAI('ai', 'Thinking...');
    const last = aiLog.lastChild;
    const res = await fetch(`${BASE_URL}/api/ai`, { method: 'POST', body: form });
    const data = await res.json();
    last.textContent = data.reply;
  });
</script>
{% endblock %}
